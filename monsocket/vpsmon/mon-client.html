<!DOCTYPE html>
<html>
  <head>
<title>EC2 Bandwidth Monitor - WebSocket & Node.JS Test Page</title>
<style type="text/css">
#io_0,#io_1,#io_2 {background: blue; color: white; padding: 5px; }
#io_3,#io_4,#io_5 {background: green; color: white; padding: 5px; }
#io_6,#io_7,#io_8 {background: red; color: white; padding: 5px; }

.montable {width: 600px; }
#out_summary { width: 600px; border: #EEEEEE solid 1px; background: #E7E7E7 }

#rx {background: red; color: white; padding: 5px; }
#tx {background: green; color: white; padding: 5px; }
</style>
<script src="jquery-1.5.min.js" type="text/javascript" charset="utf-8"></script>

</head>
<body>

<h2>VPS Mon - for EC2 (WebSocket & Node.JS)</h2>

<h3>System Usage</h3>
<table class="montable">
<thead><td>disk</td><td>mem</td><td>network</td></thead>
<tbody id="summary"></tbody>
</tr>
</table>

<h3>Network History</h3>
<div id="out_summary"></div>

<h3>Current Traffic</h3>
<table class="montable">
<thead><td>rx</td><td>tx</td></thead>
<tbody id="out_realtime"></tbody>
</tr>
</table>

<form id="msgForm">
<input size=50 type="text" id="inputMessage" value="Hello" ><button
id="sendButton">Send</button>
</form>

<pre id="output"></pre>

<script>

var output = $("#output");

var log = function(s) {
    if (document.readyState !== "complete") {
        log.buffer.push(s);
    } else {
	output.prepend(s+"\n");
    }
}
log.buffer = [];
var hostname = location.hostname;
var port = location.port;
url = "ws://"+hostname+":"+port+"/echo";
w = new WebSocket(url);
w.onopen = function() {
    log("open");
    w.send("thank you for the request");
}
w.onmessage = function(e) {
	var msg = e.data;
	var body = "";
	if(msg.match(/#mon_realtime:::/)) {
		msg = msg.split(":::")[1];
		if(msg.indexOf("rx")==0) {
			var  a = msg.split(" ");
			body += "<td id='rx'>"+a[1]+" "+a[2]+"</td>";
			body += "<td id='tx'>"+a[6]+" "+a[7]+"</td>";
			$("#out_realtime").html(body);
		}
	}
	else if(msg.match(/#mon_summary:::/)) {
		msg = msg.split(":::")[1];
		//msg = msg.replace("\n","<br>");
		$("#out_summary").html("<pre>"+msg+"</pre>");
	}
	else if(msg.match(/#mon_usage:::/)) {
		var monarr = msg.split(":::")[1].split(" ");
		var disk = monarr[3];
		var mem = monarr[5]; 
		var network = monarr[7]/1024;
		network = network.toFixed(2)
		body += "<td id='io_1'>"+disk+"%</td>"
		body += "<td id='io_2'>"+mem+"%</td>"
		body += "<td id='io_3'>"+network+"%</td>"
		$("#summary").html(body);
	}
	else if(msg.match(/#mon/)) {
		var monarr = msg.split(":")[1].split(" ");
		for(var item in monarr) {
			body += "<td id='io_"+item+"'>"+monarr[item]+"</td>"
		}
		$("#iobody").html(body);
		//log(monarr[0]);
		
	}
	else
    	log(e.data);
}
w.onclose = function(e) {
    log("closed");
}
function sendMessage() {
	w.send($("#inputMessage").val());
}
window.onload = function() {

    log(log.buffer.join("\n"));
    $("#msgForm").submit(function(){
    		event.preventDefault();
    		sendMessage();
    		$("#inputMessage").val("");
	})
}
</script>

</body>
</html>
